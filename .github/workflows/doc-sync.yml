name: Documentation Sync

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install rune
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e ".[dev]"

      - name: Run rune doc sync
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          source .venv/bin/activate
          rune --model anthropic/claude-sonnet-4-20250514 -p "$(cat <<'PROMPT'
          You are reviewing this project's documentation for accuracy.

          Your task:
          1. Read every documentation file in the repo: README.md, AGENTS.md, and
             everything under docs/. Build a list of every concrete claim each doc
             makes — CLI flags, API signatures, default values, feature descriptions,
             file paths, class/function names, config formats, and behavioral
             descriptions.
          2. For each claim, find the corresponding source code and verify it. Key
             source locations include:
             - rune/cli/main.py (CLI args, defaults, entry point)
             - rune/harness/agent.py (Agent class, AgentConfig, streaming, subagents)
             - rune/harness/tools.py (tool definitions, ToolExecutor)
             - rune/harness/providers.py (provider abstraction, model format)
             - rune/harness/permissions.py (permission levels, agent permission sets)
             - rune/harness/session.py (session management)
             - rune/harness/skills.py (skills system)
             - rune/harness/mcp_client.py (MCP integration)
             - rune/harness/agents_md.py (AGENTS.md loading)
             - rune/agents.py (agent definitions, registry)
             - pyproject.toml (dependencies, versions, build config)
          3. If a doc claim doesn't match the implementation — wrong default, missing
             flag, renamed function, outdated example, removed feature, changed
             behavior — edit the doc to match what the code actually does.
          4. Do NOT change source code. Only update documentation files.
          5. Do NOT add new documentation or new sections. Only correct existing
             content that is inaccurate.
          6. Do NOT make stylistic or cosmetic changes. Only fix factual errors.

          When you're done, print a short summary of what you changed and why, or
          state that all documentation is accurate.
          PROMPT
          )"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: automated/doc-sync
          delete-branch: true
          title: "docs: sync documentation with implementation"
          body: |
            ## Summary
            This PR was automatically generated by the `doc-sync` workflow.

            Rune reviewed all documentation files against the current source code
            and corrected any inaccuracies it found (wrong defaults, renamed
            functions, outdated examples, etc.).

            **Please review the diff carefully before merging.**
          commit-message: "docs: sync documentation with implementation"
          labels: documentation, automated
